<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Банный клуб 7 друзей</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 30, 60, 0.7);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #ff9966;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #4fc3f7;
            margin-bottom: 15px;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }

        .map-container {
            background: rgba(10, 25, 47, 0.9);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            min-height: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .location {
            position: absolute;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .location:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .location.nsk {
            top: 150px;
            left: 100px;
            background: linear-gradient(135deg, #2d5a7c, #1e3a5f);
            width: 180px;
        }

        .location.madagascar {
            top: 50px;
            right: 150px;
            background: linear-gradient(135deg, #ff8a00, #e52e71);
            width: 200px;
        }

        .location.free {
            bottom: 100px;
            left: 300px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            width: 180px;
        }

        .location.banya {
            top: 250px;
            right: 200px;
            background: linear-gradient(135deg, #ff5252, #b33939);
            width: 150px;
            opacity: 0.5;
        }

        .location.active {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .location-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #fff;
        }

        .characters-list {
            background: rgba(30, 40, 60, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            overflow-y: auto;
            max-height: 500px;
        }

        .character {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .character:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .character.active {
            background: rgba(79, 195, 247, 0.2);
            border-left-color: #4fc3f7;
        }

        .character-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.2rem;
        }

        .character-info {
            flex: 1;
        }

        .character-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #fff;
        }

        .character-location {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 3px;
        }

        .character-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
        }

        .game-controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .dialog-box {
            background: rgba(20, 30, 48, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .dialog-title {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dialog-content {
            min-height: 120px;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .dialog-choices {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .choice-btn:hover {
            background: rgba(79, 195, 247, 0.3);
            border-left-color: #4fc3f7;
            transform: translateX(5px);
        }

        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stats-panel {
            background: rgba(20, 30, 48, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .level-indicator {
            margin-bottom: 20px;
        }

        .level-title {
            color: #ff9966;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .level-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .level-bar {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #2196f3);
            width: 0%;
            transition: width 0.5s ease;
        }

        .attempts {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .attempt {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attempt.used {
            background: #f44336;
        }

        .attempt.active {
            background: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .inventory {
            margin-top: 20px;
        }

        .inventory-title {
            color: #ff9966;
            margin-bottom: 10px;
        }

        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .inventory-item {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .game-messages {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            min-height: 80px;
            max-height: 150px;
            overflow-y: auto;
        }

        .message {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .message.new {
            color: #4fc3f7;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .win-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .win-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .win-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            box-shadow: 0 0 50px rgba(79, 195, 247, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 50px rgba(79, 195, 247, 0.5); }
            50% { box-shadow: 0 0 70px rgba(79, 195, 247, 0.8); }
            100% { box-shadow: 0 0 50px rgba(79, 195, 247, 0.5); }
        }

        .win-title {
            color: #ff9966;
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .win-text {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .restart-btn {
            background: linear-gradient(135deg, #4fc3f7, #2196f3);
            border: none;
            color: white;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .connection-line {
            position: absolute;
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Банный клуб 7 друзей</h1>
            <p class="subtitle">Собери всех друзей вместе в баню! У тебя 3 попытки пройти 3 уровня</p>
            <p>Кликай на персонажей и выбирай действия в диалоговом окне</p>
        </header>

        <div class="game-area">
            <div class="map-container" id="map">
                <!-- Локации будут добавлены через JavaScript -->
            </div>

            <div class="characters-list" id="charactersList">
                <!-- Список персонажей будет добавлен через JavaScript -->
            </div>
        </div>

        <div class="game-controls">
            <div class="dialog-box">
                <div class="dialog-title">
                    <span>Диалог</span>
                    <span id="currentLevel">Уровень 1: Созвездие Кольцово</span>
                </div>
                <div class="dialog-content" id="dialogContent">
                    Добро пожаловать в игру! Кликни на любого персонажа, чтобы начать общение и понять, что нужно делать. Цель: собрать всех 7 друзей в бане!
                </div>
                <div class="dialog-choices" id="dialogChoices">
                    <!-- Варианты выбора будут добавляться через JavaScript -->
                </div>
            </div>

            <div class="stats-panel">
                <div class="level-indicator">
                    <div class="level-title">Прогресс уровня</div>
                    <div class="level-progress">
                        <div class="level-bar" id="levelProgress"></div>
                    </div>
                </div>

                <div class="attempts">
                    <div class="attempt active" id="attempt1">1</div>
                    <div class="attempt" id="attempt2">2</div>
                    <div class="attempt" id="attempt3">3</div>
                </div>

                <div class="inventory">
                    <div class="inventory-title">Инвентарь</div>
                    <div class="inventory-items" id="inventoryItems">
                        <!-- Предметы будут добавляться через JavaScript -->
                    </div>
                </div>

                <div class="game-messages" id="gameMessages">
                    <!-- Сообщения игры -->
                </div>
            </div>
        </div>
    </div>

    <div class="win-screen" id="winScreen">
        <div class="win-content">
            <h2 class="win-title">Победа!</h2>
            <p class="win-text">Пар легкий! Все 7 друзей собрались в бане! Миссия выполнена блестяще!</p>
            <p class="win-text">Пуч, Дрон, Троф, Шмель, Децина, Боб и Лёха наконец-то вместе!</p>
            <button class="restart-btn" onclick="restartGame()">Играть снова</button>
        </div>
    </div>

    <script>
        // Игровые данные
        const gameState = {
            level: 1,
            attempts: 3,
            currentAttempt: 1,
            progress: 0,
            inventory: [],
            messages: [],
            completedLevels: [],
            characters: {
                'Пуч': {
                    location: 'Нск',
                    status: 'Готов к бане, но машина сломана',
                    icon: 'П',
                    color: '#FF6B6B',
                    level1: {
                        dialog: 'Я бы всех отвез, но у меня карбюратор чихнул... Может, Боб посмотрит?',
                        actions: [
                            { text: 'Починить машину', requirement: 'Деньги на запчасти', result: 'level1_repairCar', available: false }
                        ]
                    },
                    level2: {
                        dialog: 'Машина готова! Ждем Децину и Шмеля.',
                        actions: []
                    },
                    level3: {
                        dialog: 'Я готов ехать за Шмелем, но один не вывезу - далеко.',
                        actions: [
                            { text: 'Поехать с Бобом за Шмелем', requirement: 'Согласие Боба', result: 'level3_goToFree', available: false }
                        ]
                    }
                },
                'Дрон': {
                    location: 'Нск',
                    status: 'Придумывает план',
                    icon: 'Д',
                    color: '#4ECDC4',
                    level1: {
                        dialog: 'Эй, а давайте в субботу в баню! Но нужна машина и дрова.',
                        actions: [
                            { text: 'Предложить собраться', result: 'level1_startPlan', available: true }
                        ]
                    },
                    level2: {
                        dialog: 'Децин же работает в логистике! Может, найти ему попутный груз из Мадагаскара?',
                        actions: [
                            { text: 'Искать попутный груз', requirement: 'Связь с Шмелем', result: 'level2_findCargo', available: false }
                        ]
                    },
                    level3: {
                        dialog: 'Рассчитал график: если выезжать в пятницу утром, успеете забрать Шмеля.',
                        actions: []
                    }
                },
                'Троф': {
                    location: 'Нск',
                    status: 'Связывается с Шмелем',
                    icon: 'Т',
                    color: '#FFD166',
                    level1: {
                        dialog: 'Я могу позвонить Шмелю на вахту, договориться о пиве.',
                        actions: [
                            { text: 'Позвонить Шмелю', result: 'level1_callShmel', available: true }
                        ]
                    },
                    level2: {
                        dialog: 'Шмель говорит, у его брата связи в аэропорту. Может найти чартер.',
                        actions: [
                            { text: 'Договориться о чартере', result: 'level2_arrangeCharter', available: true }
                        ]
                    },
                    level3: {
                        dialog: 'Координирую встречу Пуча и Шмеля в Свободном.',
                        actions: []
                    }
                },
                'Шмель': {
                    location: 'Свободный',
                    status: 'На вахте, освободится в субботу',
                    icon: 'Ш',
                    color: '#06D6A0',
                    level1: {
                        dialog: 'Привет! Я на вахте, освобожусь только в субботу вечером. Но могу привезти пива!',
                        actions: []
                    },
                    level2: {
                        dialog: 'Мой брат работает в аэропорту. Может найти вариант для Децины.',
                        actions: []
                    },
                    level3: {
                        dialog: 'Жду ребят в Свободном. Уже собрал вещички!',
                        actions: []
                    }
                },
                'Децина': {
                    location: 'Мадагаскар',
                    status: 'В отпуске, рейс через 2 недели',
                    icon: 'Дц',
                    color: '#118AB2',
                    level1: {
                        dialog: 'Ребзя, я бы с радостью, но мой рейс только через 2 недели!',
                        actions: []
                    },
                    level2: {
                        dialog: 'Если будет попутный груз - могу сопровождать!',
                        actions: []
                    },
                    level3: {
                        dialog: 'Лечу в Нск! Ура!',
                        actions: []
                    }
                },
                'Боб': {
                    location: 'Нск',
                    status: 'Есть инструменты, может починить',
                    icon: 'Б',
                    color: '#EF476F',
                    level1: {
                        dialog: 'Я могу починить машину Пуча, если будут запчасти.',
                        actions: [
                            { text: 'Починить машину', requirement: 'Деньги на запчасти', result: 'level1_repairCar', available: false }
                        ]
                    },
                    level2: {
                        dialog: 'Машина исправна! Теперь бы Децину и Шмеля собрать.',
                        actions: []
                    },
                    level3: {
                        dialog: 'Поеду с Пучем за Шмелем, помогу с диваном Лёхи.',
                        actions: [
                            { text: 'Поехать с Пучем', requirement: 'Согласие Лёхи', result: 'level3_goWithPuch', available: false }
                        ]
                    }
                },
                'Лёха': {
                    location: 'Нск',
                    status: 'Жадина, но есть деньги',
                    icon: 'Л',
                    color: '#7209B7',
                    level1: {
                        dialog: 'Я дам денег на запчасти, если Троф уговорит Шмеля привезти пива.',
                        actions: [
                            { text: 'Дать деньги на запчасти', requirement: 'Договор с Шмелем', result: 'level1_giveMoney', available: false }
                        ]
                    },
                    level2: {
                        dialog: 'Деньги дал. Диван мой не забудьте завезти по пути за Шмелем!',
                        actions: []
                    },
                    level3: {
                        dialog: 'Скинусь на бензин, если завезут мой диван.',
                        actions: [
                            { text: 'Скинуться на бензин', result: 'level3_giveGasMoney', available: true }
                        ]
                    }
                }
            },
            levelStates: {
                level1: {
                    carFixed: false,
                    moneyGiven: false,
                    shmelAgreed: false,
                    planStarted: false,
                    completed: false
                },
                level2: {
                    cargoFound: false,
                    charterArranged: false,
                    decinaFlying: false,
                    completed: false
                },
                level3: {
                    gasMoneyGiven: false,
                    bobAgreed: false,
                    puchGoing: false,
                    shmelPickedUp: false,
                    allInBanya: false,
                    completed: false
                }
            },
            levelProgress: {
                1: 0,
                2: 0,
                3: 0
            }
        };

        // Инициализация игры
        function initGame() {
            renderMap();
            renderCharacters();
            updateUI();
            addMessage('Игра началась! Собери всех друзей в баню!', true);
        }

        // Отрисовка карты
        function renderMap() {
            const map = document.getElementById('map');
            map.innerHTML = `
                <div class="location nsk ${gameState.level === 1 ? 'active' : ''}" data-location="nsk">
                    <div class="location-title">Нск, Кольцово</div>
                    <div>Дом друзей</div>
                </div>
                <div class="location madagascar ${gameState.level === 2 ? 'active' : ''}" data-location="madagascar">
                    <div class="location-title">Мадагаскар</div>
                    <div>Отпуск Децины</div>
                </div>
                <div class="location free ${gameState.level === 3 ? 'active' : ''}" data-location="free">
                    <div class="location-title">Свободный</div>
                    <div>Вахта Шмеля</div>
                </div>
                <div class="location banya" data-location="banya">
                    <div class="location-title">БАНЯ</div>
                    <div>Цель игры!</div>
                </div>
            `;
        }

        // Отрисовка списка персонажей
        function renderCharacters() {
            const container = document.getElementById('charactersList');
            container.innerHTML = '';
            
            Object.entries(gameState.characters).forEach(([name, data]) => {
                const charElement = document.createElement('div');
                charElement.className = 'character';
                charElement.dataset.character = name;
                charElement.onclick = () => selectCharacter(name);
                
                charElement.innerHTML = `
                    <div class="character-icon" style="background: ${data.color}">${data.icon}</div>
                    <div class="character-info">
                        <div class="character-name">${name}</div>
                        <div class="character-location">${data.location}</div>
                    </div>
                    <div class="character-status">${data.status}</div>
                `;
                
                container.appendChild(charElement);
            });
        }

        // Выбор персонажа
        let selectedCharacter = null;
        
        function selectCharacter(name) {
            // Снимаем выделение со всех персонажей
            document.querySelectorAll('.character').forEach(el => {
                el.classList.remove('active');
            });
            
            // Выделяем выбранного персонажа
            document.querySelector(`.character[data-character="${name}"]`).classList.add('active');
            
            selectedCharacter = name;
            showCharacterDialog(name);
        }

        // Показать диалог персонажа
        function showCharacterDialog(name) {
            const character = gameState.characters[name];
            const dialogContent = document.getElementById('dialogContent');
            const dialogChoices = document.getElementById('dialogChoices');
            
            let dialog = '';
            let actions = [];
            
            // Выбираем диалог в зависимости от уровня
            if (gameState.level === 1 && character.level1) {
                dialog = character.level1.dialog;
                actions = character.level1.actions || [];
            } else if (gameState.level === 2 && character.level2) {
                dialog = character.level2.dialog;
                actions = character.level2.actions || [];
            } else if (gameState.level === 3 && character.level3) {
                dialog = character.level3.dialog;
                actions = character.level3.actions || [];
            } else {
                dialog = 'Я здесь, что дальше?';
            }
            
            dialogContent.innerHTML = `<strong>${name}:</strong> ${dialog}`;
            
            // Очищаем варианты выбора
            dialogChoices.innerHTML = '';
            
            // Добавляем доступные действия
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = action.text;
                
                if (action.requirement) {
                    button.textContent += ` (Нужно: ${action.requirement})`;
                }
                
                // Проверяем, доступно ли действие
                const isAvailable = checkActionAvailability(action);
                button.disabled = !isAvailable;
                
                if (isAvailable) {
                    button.onclick = () => handleAction(action.result, name);
                }
                
                dialogChoices.appendChild(button);
            });
            
            // Если нет действий, добавляем сообщение
            if (actions.length === 0) {
                const msg = document.createElement('div');
                msg.textContent = 'Поговори с другими персонажами';
                msg.style.color = '#aaa';
                msg.style.fontStyle = 'italic';
                dialogChoices.appendChild(msg);
            }
        }

        // Проверка доступности действия
        function checkActionAvailability(action) {
            if (!action.available && action.available !== undefined) {
                return false;
            }
            
            // Проверка требований для разных действий
            switch(action.result) {
                case 'level1_repairCar':
                    return gameState.levelStates.level1.moneyGiven;
                case 'level1_giveMoney':
                    return gameState.levelStates.level1.shmelAgreed;
                case 'level2_findCargo':
                    return gameState.levelStates.level1.completed;
                case 'level3_goToFree':
                    return gameState.levelStates.level3.gasMoneyGiven && gameState.levelStates.level3.bobAgreed;
                case 'level3_goWithPuch':
                    return gameState.levelStates.level3.gasMoneyGiven;
                default:
                    return true;
            }
        }

        // Обработка действий
        function handleAction(action, character) {
            switch(action) {
                case 'level1_startPlan':
                    gameState.levelStates.level1.planStarted = true;
                    gameState.levelProgress[1] = 10;
                    addMessage('План составлен! Нужно починить машину Пуча.', true);
                    break;
                    
                case 'level1_callShmel':
                    gameState.levelStates.level1.shmelAgreed = true;
                    gameState.levelProgress[1] = 30;
                    addMessage('Шмель согласился привезти пиво! Теперь можно просить деньги у Лёхи.', true);
                    break;
                    
                case 'level1_giveMoney':
                    gameState.levelStates.level1.moneyGiven = true;
                    gameState.inventory.push('Деньги на запчасти');
                    gameState.levelProgress[1] = 50;
                    addMessage('Лёха дал деньги на запчасти! Теперь Боб может чинить машину.', true);
                    break;
                    
                case 'level1_repairCar':
                    gameState.levelStates.level1.carFixed = true;
                    gameState.inventory.push('Исправная машина');
                    gameState.levelProgress[1] = 80;
                    addMessage('Машина Пуча починена! Первый уровень почти пройден.', true);
                    // Проверяем завершение уровня 1
                    checkLevel1Completion();
                    break;
                    
                case 'level2_arrangeCharter':
                    gameState.levelStates.level2.charterArranged = true;
                    gameState.levelProgress[2] = 30;
                    addMessage('Чартер для Децины организован! Нужно найти попутный груз.', true);
                    break;
                    
                case 'level2_findCargo':
                    gameState.levelStates.level2.cargoFound = true;
                    gameState.levelProgress[2] = 60;
                    addMessage('Найден груз ванили из Мадагаскара в Нск!', true);
                    // Проверяем завершение уровня 2
                    setTimeout(() => {
                        gameState.levelStates.level2.decinaFlying = true;
                        gameState.levelProgress[2] = 100;
                        addMessage('Децина летит в Нск! Уровень 2 пройден!', true);
                        checkLevel2Completion();
                    }, 1000);
                    break;
                    
                case 'level3_giveGasMoney':
                    gameState.levelStates.level3.gasMoneyGiven = true;
                    gameState.inventory.push('Деньги на бензин');
                    gameState.levelProgress[3] = 30;
                    addMessage('Лёха скинулся на бензин! Теперь нужно уговорить Боба ехать с Пучем.', true);
                    break;
                    
                case 'level3_goWithPuch':
                    gameState.levelStates.level3.bobAgreed = true;
                    gameState.levelProgress[3] = 60;
                    addMessage('Боб согласился ехать с Пучем за Шмелем!', true);
                    break;
                    
                case 'level3_goToFree':
                    gameState.levelStates.level3.puchGoing = true;
                    gameState.levelProgress[3] = 80;
                    addMessage('Пуч и Боб выехали в Свободный за Шмелем!', true);
                    // Финальная последовательность
                    setTimeout(() => {
                        gameState.levelStates.level3.shmelPickedUp = true;
                        gameState.levelProgress[3] = 90;
                        addMessage('Шмель забран! Возвращаются в Нск.', true);
                        
                        setTimeout(() => {
                            gameState.levelStates.level3.allInBanya = true;
                            gameState.levelProgress[3] = 100;
                            addMessage('Все друзья собрались! Едем в баню!', true);
                            checkLevel3Completion();
                        }, 1500);
                    }, 1500);
                    break;
            }
            
            updateUI();
            // Показываем диалог снова, чтобы обновить доступные действия
            if (selectedCharacter) {
                showCharacterDialog(selectedCharacter);
            }
        }

        // Проверка завершения уровня 1
        function checkLevel1Completion() {
            if (gameState.levelStates.level1.carFixed && 
                gameState.levelStates.level1.planStarted &&
                gameState.levelStates.level1.moneyGiven &&
                gameState.levelStates.level1.shmelAgreed) {
                
                gameState.levelStates.level1.completed = true;
                gameState.levelProgress[1] = 100;
                gameState.completedLevels.push(1);
                
                setTimeout(() => {
                    addMessage('Уровень 1 пройден! Машина готова, местные собраны!', true);
                    // Переход ко второму уровню
                    gameState.level = 2;
                    updateUI();
                    addMessage('Уровень 2: Нужно вернуть Децину с Мадагаскара!', true);
                }, 1000);
            }
        }

        // Проверка завершения уровня 2
        function checkLevel2Completion() {
            if (gameState.levelStates.level2.decinaFlying) {
                gameState.levelStates.level2.completed = true;
                gameState.completedLevels.push(2);
                
                setTimeout(() => {
                    addMessage('Уровень 2 пройден! Децина в пути!', true);
                    // Переход к третьему уровню
                    gameState.level = 3;
                    updateUI();
                    addMessage('Уровень 3: Нужно забрать Шмеля с вахты!', true);
                }, 1000);
            }
        }

        // Проверка завершения уровня 3
        function checkLevel3Completion() {
            if (gameState.levelStates.level3.allInBanya) {
                gameState.levelStates.level3.completed = true;
                gameState.completedLevels.push(3);
                
                setTimeout(() => {
                    showWinScreen();
                }, 2000);
            }
        }

        // Добавление сообщения в лог
        function addMessage(text, isNew = false) {
            const messagesContainer = document.getElementById('gameMessages');
            const message = document.createElement('div');
            message.className = `message ${isNew ? 'new' : ''}`;
            message.textContent = text;
            
            messagesContainer.appendChild(message);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Ограничиваем количество сообщений
            if (messagesContainer.children.length > 10) {
                messagesContainer.removeChild(messagesContainer.firstChild);
            }
        }

        // Обновление интерфейса
        function updateUI() {
            // Обновляем индикатор уровня
            document.getElementById('currentLevel').textContent = 
                gameState.level === 1 ? 'Уровень 1: Созвездие Кольцово' :
                gameState.level === 2 ? 'Уровень 2: Мадагаскарский экспресс' :
                'Уровень 3: Вахтовый манёвр';
            
            // Обновляем прогресс
            const progress = gameState.levelProgress[gameState.level];
            document.getElementById('levelProgress').style.width = `${progress}%`;
            
            // Обновляем попытки
            for (let i = 1; i <= 3; i++) {
                const attempt = document.getElementById(`attempt${i}`);
                if (i < gameState.currentAttempt) {
                    attempt.className = 'attempt used';
                } else if (i === gameState.currentAttempt) {
                    attempt.className = 'attempt active';
                } else {
                    attempt.className = 'attempt';
                }
            }
            
            // Обновляем инвентарь
            const inventoryItems = document.getElementById('inventoryItems');
            inventoryItems.innerHTML = '';
            
            gameState.inventory.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item';
                itemEl.textContent = item;
                inventoryItems.appendChild(itemEl);
            });
            
            if (gameState.inventory.length === 0) {
                inventoryItems.innerHTML = '<div style="color:#aaa; font-style:italic">Инвентарь пуст</div>';
            }
            
            // Обновляем карту
            renderMap();
            
            // Обновляем статусы персонажей
            updateCharacterStatuses();
        }

        // Обновление статусов персонажей
        function updateCharacterStatuses() {
            // Обновляем статусы в зависимости от уровня и прогресса
            if (gameState.level === 1) {
                if (gameState.levelStates.level1.carFixed) {
                    gameState.characters['Пуч'].status = 'Машина починена!';
                    gameState.characters['Боб'].status = 'Машина починена';
                }
                if (gameState.levelStates.level1.shmelAgreed) {
                    gameState.characters['Троф'].status = 'Договорился с Шмелем';
                }
                if (gameState.levelStates.level1.moneyGiven) {
                    gameState.characters['Лёха'].status = 'Дал деньги';
                }
            }
            
            if (gameState.level === 2) {
                if (gameState.levelStates.level2.charterArranged) {
                    gameState.characters['Троф'].status = 'Чартер организован';
                }
                if (gameState.levelStates.level2.cargoFound) {
                    gameState.characters['Дрон'].status = 'Груз найден';
                }
                if (gameState.levelStates.level2.decinaFlying) {
                    gameState.characters['Децина'].status = 'Лечу в Нск!';
                    gameState.characters['Децина'].location = 'В пути';
                }
            }
            
            if (gameState.level === 3) {
                if (gameState.levelStates.level3.gasMoneyGiven) {
                    gameState.characters['Лёха'].status = 'Дал на бензин';
                }
                if (gameState.levelStates.level3.bobAgreed) {
                    gameState.characters['Боб'].status = 'Еду с Пучем';
                }
                if (gameState.levelStates.level3.puchGoing) {
                    gameState.characters['Пуч'].status = 'Еду за Шмелем';
                    gameState.characters['Пуч'].location = 'В пути';
                    gameState.characters['Боб'].location = 'В пути';
                }
                if (gameState.levelStates.level3.shmelPickedUp) {
                    gameState.characters['Шмель'].status = 'Едем в Нск!';
                    gameState.characters['Шмель'].location = 'В пути';
                }
                if (gameState.levelStates.level3.allInBanya) {
                    Object.keys(gameState.characters).forEach(name => {
                        gameState.characters[name].location = 'БАНЯ';
                        gameState.characters[name].status = 'В бане!';
                    });
                }
            }
            
            renderCharacters();
        }

        // Показать экран победы
        function showWinScreen() {
            document.getElementById('winScreen').classList.add('active');
        }

        // Перезапуск игры
        function restartGame() {
            // Сброс состояния игры
            Object.assign(gameState, {
                level: 1,
                attempts: 3,
                currentAttempt: 1,
                progress: 0,
                inventory: [],
                messages: [],
                completedLevels: [],
                levelStates: {
                    level1: {
                        carFixed: false,
                        moneyGiven: false,
                        shmelAgreed: false,
                        planStarted: false,
                        completed: false
                    },
                    level2: {
                        cargoFound: false,
                        charterArranged: false,
                        decinaFlying: false,
                        completed: false
                    },
                    level3: {
                        gasMoneyGiven: false,
                        bobAgreed: false,
                        puchGoing: false,
                        shmelPickedUp: false,
                        allInBanya: false,
                        completed: false
                    }
                },
                levelProgress: {
                    1: 0,
                    2: 0,
                    3: 0
                }
            });
            
            // Сброс персонажей
            const chars = gameState.characters;
            chars['Пуч'].location = 'Нск';
            chars['Пуч'].status = 'Готов к бане, но машина сломана';
            
            chars['Дрон'].location = 'Нск';
            chars['Дрон'].status = 'Придумывает план';
            
            chars['Троф'].location = 'Нск';
            chars['Троф'].status = 'Связывается с Шмелем';
            
            chars['Шмель'].location = 'Свободный';
            chars['Шмель'].status = 'На вахте, освободится в субботу';
            
            chars['Децина'].location = 'Мадагаскар';
            chars['Децина'].status = 'В отпуске, рейс через 2 недели';
            
            chars['Боб'].location = 'Нск';
            chars['Боб'].status = 'Есть инструменты, может починить';
            
            chars['Лёха'].location = 'Нск';
            chars['Лёха'].status = 'Жадина, но есть деньги';
            
            // Закрываем экран победы
            document.getElementById('winScreen').classList.remove('active');
            
            // Очищаем сообщения
            document.getElementById('gameMessages').innerHTML = '';
            
            // Перезапускаем игру
            initGame();
            addMessage('Игра перезапущена! Удачи!', true);
        }

        // Инициализируем игру при загрузке страницы
        window.onload = initGame;
    </script>
</body>
</html>
